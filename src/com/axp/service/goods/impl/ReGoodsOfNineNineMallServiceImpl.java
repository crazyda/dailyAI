package com.axp.service.goods.impl;import java.sql.Timestamp;import java.util.List;import java.util.Map;import javax.servlet.http.HttpServletRequest;import org.springframework.stereotype.Service;import com.axp.model.ReBaseGoods;import com.axp.model.ReGoodsOfBase;import com.axp.model.ReGoodsOfNineNineMall;import com.axp.query.PageResult;import com.axp.service.goods.ReGoodsOfNineNineMallService;import com.axp.service.system.impl.BaseServiceImpl;import com.axp.util.StringUtil;@Servicepublic class ReGoodsOfNineNineMallServiceImpl extends BaseServiceImpl implements ReGoodsOfNineNineMallService {    @Override    public void doSave(ReBaseGoods.MallParamter mallParamter) throws Exception {        //确保基础商品为持久化对象；        ReGoodsOfBase goods = reGoodsOfBaseDAO.findById(mallParamter.getBaseGoods().getId());        //判断是第一次投放，还是编辑投放操作；        ReGoodsOfNineNineMall g;        String goodsOrder = mallParamter.getGoodsOrder();        if (StringUtil.hasLength(goodsOrder) && goodsOrder.startsWith(ReBaseGoods.NineNineMall)) {            g = (ReGoodsOfNineNineMall) reBaseGoodsDAO.getMallObjByGoodsOrder(goodsOrder);        } else {            List<ReGoodsOfNineNineMall> list = reGoodsOfNineNineMallDAO.getGoodsByBaseGoodsId(goods.getId());            if (list == null || list.size() == 0) {                g = new ReGoodsOfNineNineMall();            } else if (list.size() == 1) {                g = list.get(0);            } else {                throw new Exception("数据库数据错误：在99商城中，相同的基础商品出现了多条记录，基础商品id值为：" + goods.getId());            }        }        //保存商城操作；        reGoodsOfNineNineMallDAO.save(g);//为了获取id值，必须做两次保存；        g.setBaseGoodsId(goods.getId());        g.setSnapshotGoods(mallParamter.getSnapshotGoods());        g.setStandardDetails(mallParamter.getStandardDetails());        g.setDisplayPrice(mallParamter.getDisplayPrice());        g.setPrice(mallParamter.getPrice());        g.setCreateTime(new Timestamp(System.currentTimeMillis()));        g.setRedPaper(0.0);//此处的红包指的是各地特产的返现的比例,为了不增加字段，就将返现比例存储在红包字段中；        g.setTransportationType(mallParamter.getTransportationType());        g.setTransportationPrice(mallParamter.getTransportationPrice());        g.setAddedTime(mallParamter.getAddedTime());        g.setShelvesTime(mallParamter.getShelvesTime());        g.setGoodsOrder(ReBaseGoods.NineNineMall + g.getId());        g.setCommentCount(0);        g.setSalesVolume(0);        g.setIsChecked(false);        if (mallParamter.getIsNoStandard()) {//如果用户勾选了无商品规格，这三个值才有意义；            g.setIsNoStandard(true);            g.setNoStandardPrice(mallParamter.getNoStandardPrice());            g.setNoStandardRepertory(mallParamter.getNoStandardRepertory());            g.setRedPaper(0.0);            g.setPrice(mallParamter.getNoStandardPrice());        } else {            g.setIsNoStandard(false);        }        //以下为商城特有字段赋值；        g.setPlaceOfProduction(mallParamter.getPlaceOfProduction());        g.setPack(mallParamter.getPack());    }    @Override    public Map<String, Object> shelves(HttpServletRequest request) {        String id = request.getParameter("id");        ReGoodsOfNineNineMall nineMall = reGoodsOfNineNineMallDAO.findById(Integer.parseInt(id));        nineMall.setIsValid(false);        reGoodsOfNineNineMallDAO.merge(nineMall);        return null;    }    @Override    public PageResult<ReGoodsOfNineNineMall> getCheckPageresult(Integer currentPage, Integer pageSize) {        return reGoodsOfNineNineMallDAO.getCheckPageresult(currentPage, pageSize);    }    @Override    public ReGoodsOfNineNineMall get(Integer checkGoodsId) {        return reGoodsOfNineNineMallDAO.findById(checkGoodsId);    }    @Override    public Map<String, Object> doCheck(Map<String, Object> returnMamp, Boolean isPass, String checkDesc, Integer goodsId) throws Exception {        ReGoodsOfNineNineMall reGoodsOfNineNineMall = reGoodsOfNineNineMallDAO.findById(goodsId);        if (isPass) {            reGoodsOfNineNineMall.setIsChecked(true);        } else {            //审核不通过（1，将isChecked设置为null，null表示审核不通过；2，此商品商家不成功，需要更改launchMall字段的值）            reGoodsOfNineNineMall.setIsChecked(null);            Integer baseGoodsId = reGoodsOfNineNineMall.getBaseGoodsId();            ReGoodsOfBase baseGoods = reGoodsOfBaseDAO.findById(baseGoodsId);            String s = baseGoods.changeLaunchMall(baseGoods.getLaunchMall(), ReGoodsOfBase.nineNineMall, false);            baseGoods.setLaunchMall(s);        }        reGoodsOfNineNineMall.setCheckDesc(checkDesc);        //返回返回值；        returnMamp.put("success", true);        returnMamp.put("message", "操作完成；");        return returnMamp;    }}